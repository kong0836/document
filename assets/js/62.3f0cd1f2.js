(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{450:function(t,a,s){"use strict";s.r(a);var e=s(44),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"高可用实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#高可用实现"}},[t._v("#")]),t._v(" 高可用实现")]),t._v(" "),s("h3",{attrs:{id:"什么是高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是高可用"}},[t._v("#")]),t._v(" 什么是高可用？")]),t._v(" "),s("p",[t._v("高可用HA（High Availability）是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。\n如果一个系统能够一直提供服务，那么这个可用性则是百分之百，但是天有不测风云。所以我们只能尽可能的去减少服务的故障。")]),t._v(" "),s("h3",{attrs:{id:"双机热备方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#双机热备方案"}},[t._v("#")]),t._v(" 双机热备方案")]),t._v(" "),s("p",[t._v("这种方案是国内企业中最为普遍的一种高可用方案，双机热备其实就是指一台服务器在提供服务，另一台为某服务的备用状态，当一台服务器不可用另外一台就会顶替上去。")]),t._v(" "),s("h3",{attrs:{id:"keepalived是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#keepalived是什么"}},[t._v("#")]),t._v(" keepalived是什么？")]),t._v(" "),s("p",[t._v("Keepalived软件起初是专为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP (Virtual Router Redundancy Protocol ,虚拟路由器冗余协议）功能。\n因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL等）的高可用解决方案软件。")]),t._v(" "),s("h3",{attrs:{id:"故障转移机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#故障转移机制"}},[t._v("#")]),t._v(" 故障转移机制")]),t._v(" "),s("p",[t._v("Keepalived高可用服务之间的故障切换转移，是通过VRRP 来实现的。\n在 Keepalived服务正常工作时，主 Master节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备Backup节点自己还活着，当主 Master节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master节点的心跳了，于是调用自身的接管程序，接管主Master节点的 IP资源及服务。\n而当主 Master节点恢复时，备Backup节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。")]),t._v(" "),s("h3",{attrs:{id:"实现过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现过程"}},[t._v("#")]),t._v(" 实现过程")]),t._v(" "),s("ul",[s("li",[t._v("准备工作")])]),t._v(" "),s("p",[t._v("两台Linux服务器")]),t._v(" "),s("ul",[s("li",[t._v("安装Nginx")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新yum源文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rpm")]),t._v(" -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装Nginx")]),t._v("\nyum -y "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n")])])]),s("ul",[s("li",[t._v("操作命令")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#启动Nginx")]),t._v("\nsystemctl start nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#停止Nginx")]),t._v("\nsystemctl stop nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ul",[s("li",[t._v("安装keepalived")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("yum -y "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" keepalived\n")])])]),s("ul",[s("li",[t._v("修改主机（192.168.16.128）keepalived配置文件")])]),t._v(" "),s("p",[t._v("yum方式安装的会生产配置文件在/etc/keepalived下：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/keepalived/keepalived.conf\n")])])]),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检测脚本")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("vrrp_script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("chk_http_port {")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t# 心跳执行的脚本，检测nginx是否启动")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v('"/usr/local/src/check_nginx_pid.sh"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t#（检测脚本执行的间隔，单位是秒）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("\tinterval")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    weight")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("2 #权重")]),t._v("\n}\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#vrrp 实例定义部分")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("vrrp_instance")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("VI_1 {")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t# 指定keepalived的角色，MASTER为主，BACKUP为备")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("\tstate")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("MASTER")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t# 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("ens33")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 虚拟路由编号，主从要一直")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    virtual_router_id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("66")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 优先级，数值越大，获取处理请求的优先级越高")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    priority")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("100")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 检查间隔，默认为1s(vrrp组播周期秒数)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    advert_int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 授权访问")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    authentication")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    \t# 设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("        auth_type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("PASS")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("        auth_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("1111")]),t._v("\n    }\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    track_script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t    # 调用检测脚本")]),t._v("\n        chk_http_port\n    }\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    virtual_ipaddress")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    \t# 定义虚拟ip(VIP)，可多设，每行一个")]),t._v("\n        192.168.16.130\n    }\n}\n")])])]),s("p",[t._v("virtual_ipaddress 里面可以配置vip,在线上通过vip来访问服务。interface 需要根据服务器网卡进行设置通常查看方式 ip addr\nauthentication配置授权访问后备机也需要相同配置")]),t._v(" "),s("ul",[s("li",[t._v("修改备机（192.168.16.129）keepalived配置文件")])]),t._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检测脚本")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("vrrp_script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("chk_http_port {")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t# 心跳执行的脚本，检测nginx是否启动")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v('"/usr/local/src/check_nginx_pid.sh"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    interval")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("2 #（检测脚本执行的间隔）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    weight")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("2 #权重")]),t._v("\n}\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#vrrp 实例定义部分")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("vrrp_instance")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("VI_1 {")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t# 指定keepalived的角色，MASTER为主，BACKUP为备")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    state")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("BACKUP")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("ens33")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 虚拟路由编号，主从要一直")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    virtual_router_id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("66")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 优先级，数值越大，获取处理请求的优先级越高")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    priority")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("99")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 检查间隔，默认为1s(vrrp组播周期秒数)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    advert_int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("    # 授权访问")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    authentication")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t    # 设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("        auth_type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("PASS")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("        auth_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("1111")]),t._v("\n    }\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    track_script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t    # 调用检测脚本")]),t._v("\n        chk_http_port\n    }\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("    virtual_ipaddress")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\t    # 定义虚拟ip(VIP)，可多设，每行一个")]),t._v("\n        192.168.16.130\n    }\n}\n")])])]),s("ul",[s("li",[t._v("检测脚本")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检测nginx是否启动了")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("A")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -C nginx --no-header "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wc")]),t._v(" -l"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果nginx没有启动就启动nginx")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$A")]),t._v(" -eq "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" \n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启nginx")]),t._v("\n      systemctl start nginx\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# nginx重启失败，则停掉keepalived服务，进行VIP转移")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -C nginx --no-header "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wc")]),t._v(" -l"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v(" -eq "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("killall")]),t._v(" keepalived\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),s("ul",[s("li",[t._v("脚本授权")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("775")]),t._v(" check_nginx_pid.sh\n")])])]),s("p",[t._v("说明：脚本必须通过授权，不然没权限访问啊，在这里我们两条服务器执行、VIP(virtual_ipaddress:192.168.16.130),我们在生产环境是直接通过vip来访问服务。")]),t._v(" "),s("ul",[s("li",[t._v("模拟nginx故障：\n修改两个服务器默认访问的Nginx的html页面作为区别。\n首先访问192.168.16.130,通过vip进行访问，页面显示192.168.16.128；说明当前是主服务器提供的服务。\n这个时候192.168.16.128主服务器执行命令：\nsystemctl stop nginx; #停止nginx\n再次访问vip(192.168.16.130)发现这个时候页面显示的还是：192.168.16.128，这是脚本里面自动重启。\n现在直接将192.168.16.128服务器关闭，在此访问vip(192.168.16.130)现在发现页面显示192.168.16.129，这个时候keepalived就自动故障转移了，一套企业级生产环境的高可用方案就搭建好了。\nkeepalived中还有许多功能比如：邮箱提醒啊等等，就不操作了，可以去官网看看文档。")])]),t._v(" "),s("h3",{attrs:{id:"原文地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原文地址"}},[t._v("#")]),t._v(" 原文地址")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://mp.weixin.qq.com/s/y5tD1Usgs4mHpbDwsZEYbg",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://mp.weixin.qq.com/s/y5tD1Usgs4mHpbDwsZEYbg"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);