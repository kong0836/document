<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高可用实现 | 学以致用</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/document/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/document/assets/css/0.styles.b4b90528.css" as="style"><link rel="preload" href="/document/assets/js/app.3d477e64.js" as="script"><link rel="preload" href="/document/assets/js/2.3edc90c1.js" as="script"><link rel="preload" href="/document/assets/js/62.3f0cd1f2.js" as="script"><link rel="prefetch" href="/document/assets/js/10.a5b67d54.js"><link rel="prefetch" href="/document/assets/js/11.491f357c.js"><link rel="prefetch" href="/document/assets/js/12.93cb07f2.js"><link rel="prefetch" href="/document/assets/js/13.4ef33c6a.js"><link rel="prefetch" href="/document/assets/js/14.696a367f.js"><link rel="prefetch" href="/document/assets/js/15.13fe1ba8.js"><link rel="prefetch" href="/document/assets/js/16.34829869.js"><link rel="prefetch" href="/document/assets/js/17.5a68e19e.js"><link rel="prefetch" href="/document/assets/js/18.d05cd448.js"><link rel="prefetch" href="/document/assets/js/19.83faa546.js"><link rel="prefetch" href="/document/assets/js/20.f0b0285d.js"><link rel="prefetch" href="/document/assets/js/21.37dee404.js"><link rel="prefetch" href="/document/assets/js/22.0c60f27d.js"><link rel="prefetch" href="/document/assets/js/23.dede927d.js"><link rel="prefetch" href="/document/assets/js/24.71604aa9.js"><link rel="prefetch" href="/document/assets/js/25.e68235ac.js"><link rel="prefetch" href="/document/assets/js/26.a1cf5a49.js"><link rel="prefetch" href="/document/assets/js/27.31cce998.js"><link rel="prefetch" href="/document/assets/js/28.b16c6d75.js"><link rel="prefetch" href="/document/assets/js/29.63e6b366.js"><link rel="prefetch" href="/document/assets/js/3.5206b020.js"><link rel="prefetch" href="/document/assets/js/30.82d8c9d8.js"><link rel="prefetch" href="/document/assets/js/31.c8b94945.js"><link rel="prefetch" href="/document/assets/js/32.57b6d187.js"><link rel="prefetch" href="/document/assets/js/33.978b4579.js"><link rel="prefetch" href="/document/assets/js/34.6c54233f.js"><link rel="prefetch" href="/document/assets/js/35.feddeb32.js"><link rel="prefetch" href="/document/assets/js/36.3c5db940.js"><link rel="prefetch" href="/document/assets/js/37.73d6a9a9.js"><link rel="prefetch" href="/document/assets/js/38.90a8597a.js"><link rel="prefetch" href="/document/assets/js/39.12eb49b9.js"><link rel="prefetch" href="/document/assets/js/4.59f59ebf.js"><link rel="prefetch" href="/document/assets/js/40.b1d213b9.js"><link rel="prefetch" href="/document/assets/js/41.b71e17a9.js"><link rel="prefetch" href="/document/assets/js/42.5383a4bc.js"><link rel="prefetch" href="/document/assets/js/43.dc9b6fbb.js"><link rel="prefetch" href="/document/assets/js/44.96a769a6.js"><link rel="prefetch" href="/document/assets/js/45.ac62bc64.js"><link rel="prefetch" href="/document/assets/js/46.99752745.js"><link rel="prefetch" href="/document/assets/js/47.a472a150.js"><link rel="prefetch" href="/document/assets/js/48.8cd2290a.js"><link rel="prefetch" href="/document/assets/js/49.6e0d6556.js"><link rel="prefetch" href="/document/assets/js/5.9dd0657f.js"><link rel="prefetch" href="/document/assets/js/50.ebf1c05c.js"><link rel="prefetch" href="/document/assets/js/51.d1f58980.js"><link rel="prefetch" href="/document/assets/js/52.c4e65d54.js"><link rel="prefetch" href="/document/assets/js/53.dfee9c96.js"><link rel="prefetch" href="/document/assets/js/54.d158815c.js"><link rel="prefetch" href="/document/assets/js/55.fa967497.js"><link rel="prefetch" href="/document/assets/js/56.93abfeea.js"><link rel="prefetch" href="/document/assets/js/57.d4699bfc.js"><link rel="prefetch" href="/document/assets/js/58.5fae4113.js"><link rel="prefetch" href="/document/assets/js/59.b3a0d72b.js"><link rel="prefetch" href="/document/assets/js/6.54a4436c.js"><link rel="prefetch" href="/document/assets/js/60.978d2e19.js"><link rel="prefetch" href="/document/assets/js/61.b0b5744a.js"><link rel="prefetch" href="/document/assets/js/63.9a0689be.js"><link rel="prefetch" href="/document/assets/js/64.e5270351.js"><link rel="prefetch" href="/document/assets/js/65.ef86931a.js"><link rel="prefetch" href="/document/assets/js/66.469f8064.js"><link rel="prefetch" href="/document/assets/js/67.e2d60635.js"><link rel="prefetch" href="/document/assets/js/68.426a3502.js"><link rel="prefetch" href="/document/assets/js/69.aa591181.js"><link rel="prefetch" href="/document/assets/js/7.b85c084a.js"><link rel="prefetch" href="/document/assets/js/70.f185f32f.js"><link rel="prefetch" href="/document/assets/js/71.a968cf49.js"><link rel="prefetch" href="/document/assets/js/72.cd76ca55.js"><link rel="prefetch" href="/document/assets/js/73.9c171c12.js"><link rel="prefetch" href="/document/assets/js/74.cb8a6ba2.js"><link rel="prefetch" href="/document/assets/js/75.54aaad5d.js"><link rel="prefetch" href="/document/assets/js/76.113b4705.js"><link rel="prefetch" href="/document/assets/js/77.6867aad9.js"><link rel="prefetch" href="/document/assets/js/78.ca0938d3.js"><link rel="prefetch" href="/document/assets/js/79.d7edfb45.js"><link rel="prefetch" href="/document/assets/js/8.d9ac3499.js"><link rel="prefetch" href="/document/assets/js/80.03ce8704.js"><link rel="prefetch" href="/document/assets/js/81.314bf80b.js"><link rel="prefetch" href="/document/assets/js/82.7f503861.js"><link rel="prefetch" href="/document/assets/js/83.5fce3e32.js"><link rel="prefetch" href="/document/assets/js/84.ae309fb5.js"><link rel="prefetch" href="/document/assets/js/85.0c25c1b8.js"><link rel="prefetch" href="/document/assets/js/86.d6e7d2ad.js"><link rel="prefetch" href="/document/assets/js/9.c3de7e78.js">
    <link rel="stylesheet" href="/document/assets/css/0.styles.b4b90528.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/document/" class="home-link router-link-active"><img src="/document/assets/img/logo.png" alt="学以致用" class="logo"> <span class="site-name can-hide">学以致用</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/document/ElementUI/" class="nav-link">
  ElementUI
</a></li><li class="dropdown-item"><!----> <a href="/document/JavaScript/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/document/设计模式/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/document/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/document/Maven/" class="nav-link">
  Maven
</a></li><li class="dropdown-item"><!----> <a href="/document/Nexus/" class="nav-link">
  Nexus
</a></li><li class="dropdown-item"><!----> <a href="/document/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/document/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/document/Redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/document/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/document/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/document/CentOS/" class="nav-link">
  CentOS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web服务器" class="dropdown-title"><span class="title">Web服务器</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web服务器" class="mobile-dropdown-title"><span class="title">Web服务器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/document/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/document/Eureka/" class="nav-link">
  Eureka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="性能测试" class="dropdown-title"><span class="title">性能测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="性能测试" class="mobile-dropdown-title"><span class="title">性能测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Jmeter/" class="nav-link">
  Jemter
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/document/ElementUI/" class="nav-link">
  ElementUI
</a></li><li class="dropdown-item"><!----> <a href="/document/JavaScript/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/document/设计模式/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/document/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/document/Maven/" class="nav-link">
  Maven
</a></li><li class="dropdown-item"><!----> <a href="/document/Nexus/" class="nav-link">
  Nexus
</a></li><li class="dropdown-item"><!----> <a href="/document/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/document/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/document/Redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/document/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/document/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/document/CentOS/" class="nav-link">
  CentOS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web服务器" class="dropdown-title"><span class="title">Web服务器</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web服务器" class="mobile-dropdown-title"><span class="title">Web服务器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/document/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/document/Eureka/" class="nav-link">
  Eureka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="性能测试" class="dropdown-title"><span class="title">性能测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="性能测试" class="mobile-dropdown-title"><span class="title">性能测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Jmeter/" class="nav-link">
  Jemter
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/document/Nginx/01-安装与配置.html" class="sidebar-link">安装与配置</a></li><li><a href="/document/Nginx/02-基本配置与优化.html" class="sidebar-link">基本配置与优化</a></li><li><a href="/document/Nginx/高可用实现.html" class="active sidebar-link">高可用实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#高可用实现" class="sidebar-link">高可用实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#什么是高可用" class="sidebar-link">什么是高可用？</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#双机热备方案" class="sidebar-link">双机热备方案</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#keepalived是什么" class="sidebar-link">keepalived是什么？</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#故障转移机制" class="sidebar-link">故障转移机制</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#实现过程" class="sidebar-link">实现过程</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/高可用实现.html#原文地址" class="sidebar-link">原文地址</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="高可用实现"><a href="#高可用实现" class="header-anchor">#</a> 高可用实现</h2> <h3 id="什么是高可用"><a href="#什么是高可用" class="header-anchor">#</a> 什么是高可用？</h3> <p>高可用HA（High Availability）是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。
如果一个系统能够一直提供服务，那么这个可用性则是百分之百，但是天有不测风云。所以我们只能尽可能的去减少服务的故障。</p> <h3 id="双机热备方案"><a href="#双机热备方案" class="header-anchor">#</a> 双机热备方案</h3> <p>这种方案是国内企业中最为普遍的一种高可用方案，双机热备其实就是指一台服务器在提供服务，另一台为某服务的备用状态，当一台服务器不可用另外一台就会顶替上去。</p> <h3 id="keepalived是什么"><a href="#keepalived是什么" class="header-anchor">#</a> keepalived是什么？</h3> <p>Keepalived软件起初是专为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP (Virtual Router Redundancy Protocol ,虚拟路由器冗余协议）功能。
因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL等）的高可用解决方案软件。</p> <h3 id="故障转移机制"><a href="#故障转移机制" class="header-anchor">#</a> 故障转移机制</h3> <p>Keepalived高可用服务之间的故障切换转移，是通过VRRP 来实现的。
在 Keepalived服务正常工作时，主 Master节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备Backup节点自己还活着，当主 Master节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master节点的心跳了，于是调用自身的接管程序，接管主Master节点的 IP资源及服务。
而当主 Master节点恢复时，备Backup节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。</p> <h3 id="实现过程"><a href="#实现过程" class="header-anchor">#</a> 实现过程</h3> <ul><li>准备工作</li></ul> <p>两台Linux服务器</p> <ul><li>安装Nginx</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 更新yum源文件</span>
<span class="token function">rpm</span> -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
<span class="token function">wget</span> -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
<span class="token comment"># 安装Nginx</span>
yum -y <span class="token function">install</span> nginx
</code></pre></div><ul><li>操作命令</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#启动Nginx</span>
systemctl start nginx<span class="token punctuation">;</span>
<span class="token comment">#停止Nginx</span>
systemctl stop nginx<span class="token punctuation">;</span>
</code></pre></div><ul><li>安装keepalived</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yum -y <span class="token function">install</span> keepalived
</code></pre></div><ul><li>修改主机（192.168.16.128）keepalived配置文件</li></ul> <p>yum方式安装的会生产配置文件在/etc/keepalived下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre></div><div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 检测脚本</span>
<span class="token attr-name">vrrp_script</span> <span class="token attr-value">chk_http_port {</span>
<span class="token comment">	# 心跳执行的脚本，检测nginx是否启动</span>
<span class="token attr-name">    script</span> <span class="token attr-value">&quot;/usr/local/src/check_nginx_pid.sh&quot;</span>
<span class="token comment">	#（检测脚本执行的间隔，单位是秒）</span>
<span class="token attr-name">	interval</span> <span class="token attr-value">2</span>
<span class="token attr-name">    weight</span> <span class="token attr-value">2 #权重</span>
}
<span class="token comment">#vrrp 实例定义部分</span>
<span class="token attr-name">vrrp_instance</span> <span class="token attr-value">VI_1 {</span>
<span class="token comment">	# 指定keepalived的角色，MASTER为主，BACKUP为备</span>
<span class="token attr-name">	state</span> <span class="token attr-value">MASTER</span>
<span class="token comment">	# 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡</span>
<span class="token attr-name">    interface</span> <span class="token attr-value">ens33</span>
<span class="token comment">    # 虚拟路由编号，主从要一直</span>
<span class="token attr-name">    virtual_router_id</span> <span class="token attr-value">66</span>
<span class="token comment">    # 优先级，数值越大，获取处理请求的优先级越高</span>
<span class="token attr-name">    priority</span> <span class="token attr-value">100</span>
<span class="token comment">    # 检查间隔，默认为1s(vrrp组播周期秒数)</span>
<span class="token attr-name">    advert_int</span> <span class="token attr-value">1</span>
<span class="token comment">    # 授权访问</span>
<span class="token attr-name">    authentication</span> <span class="token attr-value">{</span>
<span class="token comment">    	# 设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信</span>
<span class="token attr-name">        auth_type</span> <span class="token attr-value">PASS</span>
<span class="token attr-name">        auth_pass</span> <span class="token attr-value">1111</span>
    }
<span class="token attr-name">    track_script</span> <span class="token attr-value">{</span>
<span class="token comment">	    # 调用检测脚本</span>
        chk_http_port
    }
<span class="token attr-name">    virtual_ipaddress</span> <span class="token attr-value">{</span>
<span class="token comment">    	# 定义虚拟ip(VIP)，可多设，每行一个</span>
        192.168.16.130
    }
}
</code></pre></div><p>virtual_ipaddress 里面可以配置vip,在线上通过vip来访问服务。interface 需要根据服务器网卡进行设置通常查看方式 ip addr
authentication配置授权访问后备机也需要相同配置</p> <ul><li>修改备机（192.168.16.129）keepalived配置文件</li></ul> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 检测脚本</span>
<span class="token attr-name">vrrp_script</span> <span class="token attr-value">chk_http_port {</span>
<span class="token comment">	# 心跳执行的脚本，检测nginx是否启动</span>
<span class="token attr-name">    script</span> <span class="token attr-value">&quot;/usr/local/src/check_nginx_pid.sh&quot;</span>
<span class="token attr-name">    interval</span> <span class="token attr-value">2 #（检测脚本执行的间隔）</span>
<span class="token attr-name">    weight</span> <span class="token attr-value">2 #权重</span>
}
<span class="token comment">#vrrp 实例定义部分</span>
<span class="token attr-name">vrrp_instance</span> <span class="token attr-value">VI_1 {</span>
<span class="token comment">	# 指定keepalived的角色，MASTER为主，BACKUP为备</span>
<span class="token attr-name">    state</span> <span class="token attr-value">BACKUP</span>
<span class="token comment">    # 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡</span>
<span class="token attr-name">    interface</span> <span class="token attr-value">ens33</span>
<span class="token comment">    # 虚拟路由编号，主从要一直</span>
<span class="token attr-name">    virtual_router_id</span> <span class="token attr-value">66</span>
<span class="token comment">    # 优先级，数值越大，获取处理请求的优先级越高</span>
<span class="token attr-name">    priority</span> <span class="token attr-value">99</span>
<span class="token comment">    # 检查间隔，默认为1s(vrrp组播周期秒数)</span>
<span class="token attr-name">    advert_int</span> <span class="token attr-value">1</span>
<span class="token comment">    # 授权访问</span>
<span class="token attr-name">    authentication</span> <span class="token attr-value">{</span>
<span class="token comment">	    # 设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信</span>
<span class="token attr-name">        auth_type</span> <span class="token attr-value">PASS</span>
<span class="token attr-name">        auth_pass</span> <span class="token attr-value">1111</span>
    }
<span class="token attr-name">    track_script</span> <span class="token attr-value">{</span>
<span class="token comment">	    # 调用检测脚本</span>
        chk_http_port
    }
<span class="token attr-name">    virtual_ipaddress</span> <span class="token attr-value">{</span>
<span class="token comment">	    # 定义虚拟ip(VIP)，可多设，每行一个</span>
        192.168.16.130
    }
}
</code></pre></div><ul><li>检测脚本</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 检测nginx是否启动了</span>
<span class="token assign-left variable">A</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>
<span class="token comment"># 如果nginx没有启动就启动nginx</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$A</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> 
	<span class="token comment"># 重启nginx</span>
      systemctl start nginx
      <span class="token comment"># nginx重启失败，则停掉keepalived服务，进行VIP转移</span>
      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
              <span class="token function">killall</span> keepalived
      <span class="token keyword">fi</span>
<span class="token keyword">fi</span>
</code></pre></div><ul><li>脚本授权</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> <span class="token number">775</span> check_nginx_pid.sh
</code></pre></div><p>说明：脚本必须通过授权，不然没权限访问啊，在这里我们两条服务器执行、VIP(virtual_ipaddress:192.168.16.130),我们在生产环境是直接通过vip来访问服务。</p> <ul><li>模拟nginx故障：
修改两个服务器默认访问的Nginx的html页面作为区别。
首先访问192.168.16.130,通过vip进行访问，页面显示192.168.16.128；说明当前是主服务器提供的服务。
这个时候192.168.16.128主服务器执行命令：
systemctl stop nginx; #停止nginx
再次访问vip(192.168.16.130)发现这个时候页面显示的还是：192.168.16.128，这是脚本里面自动重启。
现在直接将192.168.16.128服务器关闭，在此访问vip(192.168.16.130)现在发现页面显示192.168.16.129，这个时候keepalived就自动故障转移了，一套企业级生产环境的高可用方案就搭建好了。
keepalived中还有许多功能比如：邮箱提醒啊等等，就不操作了，可以去官网看看文档。</li></ul> <h3 id="原文地址"><a href="#原文地址" class="header-anchor">#</a> 原文地址</h3> <ul><li><a href="https://mp.weixin.qq.com/s/y5tD1Usgs4mHpbDwsZEYbg" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/y5tD1Usgs4mHpbDwsZEYbg<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">2021-08-24 17:34:01</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/document/Nginx/02-基本配置与优化.html" class="prev">
        基本配置与优化
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/document/assets/js/app.3d477e64.js" defer></script><script src="/document/assets/js/2.3edc90c1.js" defer></script><script src="/document/assets/js/62.3f0cd1f2.js" defer></script>
  </body>
</html>
