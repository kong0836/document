<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基本配置与优化 | 学以致用</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/document/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/document/assets/css/0.styles.b4b90528.css" as="style"><link rel="preload" href="/document/assets/js/app.3d477e64.js" as="script"><link rel="preload" href="/document/assets/js/2.3edc90c1.js" as="script"><link rel="preload" href="/document/assets/js/59.b3a0d72b.js" as="script"><link rel="prefetch" href="/document/assets/js/10.a5b67d54.js"><link rel="prefetch" href="/document/assets/js/11.491f357c.js"><link rel="prefetch" href="/document/assets/js/12.93cb07f2.js"><link rel="prefetch" href="/document/assets/js/13.4ef33c6a.js"><link rel="prefetch" href="/document/assets/js/14.696a367f.js"><link rel="prefetch" href="/document/assets/js/15.13fe1ba8.js"><link rel="prefetch" href="/document/assets/js/16.34829869.js"><link rel="prefetch" href="/document/assets/js/17.5a68e19e.js"><link rel="prefetch" href="/document/assets/js/18.d05cd448.js"><link rel="prefetch" href="/document/assets/js/19.83faa546.js"><link rel="prefetch" href="/document/assets/js/20.f0b0285d.js"><link rel="prefetch" href="/document/assets/js/21.37dee404.js"><link rel="prefetch" href="/document/assets/js/22.0c60f27d.js"><link rel="prefetch" href="/document/assets/js/23.dede927d.js"><link rel="prefetch" href="/document/assets/js/24.71604aa9.js"><link rel="prefetch" href="/document/assets/js/25.e68235ac.js"><link rel="prefetch" href="/document/assets/js/26.a1cf5a49.js"><link rel="prefetch" href="/document/assets/js/27.31cce998.js"><link rel="prefetch" href="/document/assets/js/28.b16c6d75.js"><link rel="prefetch" href="/document/assets/js/29.63e6b366.js"><link rel="prefetch" href="/document/assets/js/3.5206b020.js"><link rel="prefetch" href="/document/assets/js/30.82d8c9d8.js"><link rel="prefetch" href="/document/assets/js/31.c8b94945.js"><link rel="prefetch" href="/document/assets/js/32.57b6d187.js"><link rel="prefetch" href="/document/assets/js/33.978b4579.js"><link rel="prefetch" href="/document/assets/js/34.6c54233f.js"><link rel="prefetch" href="/document/assets/js/35.feddeb32.js"><link rel="prefetch" href="/document/assets/js/36.3c5db940.js"><link rel="prefetch" href="/document/assets/js/37.73d6a9a9.js"><link rel="prefetch" href="/document/assets/js/38.90a8597a.js"><link rel="prefetch" href="/document/assets/js/39.12eb49b9.js"><link rel="prefetch" href="/document/assets/js/4.59f59ebf.js"><link rel="prefetch" href="/document/assets/js/40.b1d213b9.js"><link rel="prefetch" href="/document/assets/js/41.b71e17a9.js"><link rel="prefetch" href="/document/assets/js/42.5383a4bc.js"><link rel="prefetch" href="/document/assets/js/43.dc9b6fbb.js"><link rel="prefetch" href="/document/assets/js/44.96a769a6.js"><link rel="prefetch" href="/document/assets/js/45.ac62bc64.js"><link rel="prefetch" href="/document/assets/js/46.99752745.js"><link rel="prefetch" href="/document/assets/js/47.a472a150.js"><link rel="prefetch" href="/document/assets/js/48.8cd2290a.js"><link rel="prefetch" href="/document/assets/js/49.6e0d6556.js"><link rel="prefetch" href="/document/assets/js/5.9dd0657f.js"><link rel="prefetch" href="/document/assets/js/50.ebf1c05c.js"><link rel="prefetch" href="/document/assets/js/51.d1f58980.js"><link rel="prefetch" href="/document/assets/js/52.c4e65d54.js"><link rel="prefetch" href="/document/assets/js/53.dfee9c96.js"><link rel="prefetch" href="/document/assets/js/54.d158815c.js"><link rel="prefetch" href="/document/assets/js/55.fa967497.js"><link rel="prefetch" href="/document/assets/js/56.93abfeea.js"><link rel="prefetch" href="/document/assets/js/57.d4699bfc.js"><link rel="prefetch" href="/document/assets/js/58.5fae4113.js"><link rel="prefetch" href="/document/assets/js/6.54a4436c.js"><link rel="prefetch" href="/document/assets/js/60.978d2e19.js"><link rel="prefetch" href="/document/assets/js/61.b0b5744a.js"><link rel="prefetch" href="/document/assets/js/62.3f0cd1f2.js"><link rel="prefetch" href="/document/assets/js/63.9a0689be.js"><link rel="prefetch" href="/document/assets/js/64.e5270351.js"><link rel="prefetch" href="/document/assets/js/65.ef86931a.js"><link rel="prefetch" href="/document/assets/js/66.469f8064.js"><link rel="prefetch" href="/document/assets/js/67.e2d60635.js"><link rel="prefetch" href="/document/assets/js/68.426a3502.js"><link rel="prefetch" href="/document/assets/js/69.aa591181.js"><link rel="prefetch" href="/document/assets/js/7.b85c084a.js"><link rel="prefetch" href="/document/assets/js/70.f185f32f.js"><link rel="prefetch" href="/document/assets/js/71.a968cf49.js"><link rel="prefetch" href="/document/assets/js/72.cd76ca55.js"><link rel="prefetch" href="/document/assets/js/73.9c171c12.js"><link rel="prefetch" href="/document/assets/js/74.cb8a6ba2.js"><link rel="prefetch" href="/document/assets/js/75.54aaad5d.js"><link rel="prefetch" href="/document/assets/js/76.113b4705.js"><link rel="prefetch" href="/document/assets/js/77.6867aad9.js"><link rel="prefetch" href="/document/assets/js/78.ca0938d3.js"><link rel="prefetch" href="/document/assets/js/79.d7edfb45.js"><link rel="prefetch" href="/document/assets/js/8.d9ac3499.js"><link rel="prefetch" href="/document/assets/js/80.03ce8704.js"><link rel="prefetch" href="/document/assets/js/81.314bf80b.js"><link rel="prefetch" href="/document/assets/js/82.7f503861.js"><link rel="prefetch" href="/document/assets/js/83.5fce3e32.js"><link rel="prefetch" href="/document/assets/js/84.ae309fb5.js"><link rel="prefetch" href="/document/assets/js/85.0c25c1b8.js"><link rel="prefetch" href="/document/assets/js/86.d6e7d2ad.js"><link rel="prefetch" href="/document/assets/js/9.c3de7e78.js">
    <link rel="stylesheet" href="/document/assets/css/0.styles.b4b90528.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/document/" class="home-link router-link-active"><img src="/document/assets/img/logo.png" alt="学以致用" class="logo"> <span class="site-name can-hide">学以致用</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/document/ElementUI/" class="nav-link">
  ElementUI
</a></li><li class="dropdown-item"><!----> <a href="/document/JavaScript/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/document/设计模式/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/document/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/document/Maven/" class="nav-link">
  Maven
</a></li><li class="dropdown-item"><!----> <a href="/document/Nexus/" class="nav-link">
  Nexus
</a></li><li class="dropdown-item"><!----> <a href="/document/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/document/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/document/Redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/document/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/document/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/document/CentOS/" class="nav-link">
  CentOS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web服务器" class="dropdown-title"><span class="title">Web服务器</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web服务器" class="mobile-dropdown-title"><span class="title">Web服务器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/document/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/document/Eureka/" class="nav-link">
  Eureka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="性能测试" class="dropdown-title"><span class="title">性能测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="性能测试" class="mobile-dropdown-title"><span class="title">性能测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Jmeter/" class="nav-link">
  Jemter
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/document/ElementUI/" class="nav-link">
  ElementUI
</a></li><li class="dropdown-item"><!----> <a href="/document/JavaScript/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/document/设计模式/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/document/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/document/Maven/" class="nav-link">
  Maven
</a></li><li class="dropdown-item"><!----> <a href="/document/Nexus/" class="nav-link">
  Nexus
</a></li><li class="dropdown-item"><!----> <a href="/document/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/document/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/document/Redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/document/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/document/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/document/CentOS/" class="nav-link">
  CentOS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web服务器" class="dropdown-title"><span class="title">Web服务器</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web服务器" class="mobile-dropdown-title"><span class="title">Web服务器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/document/Tomcat/" class="nav-link">
  Tomcat
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/document/Eureka/" class="nav-link">
  Eureka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="性能测试" class="dropdown-title"><span class="title">性能测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="性能测试" class="mobile-dropdown-title"><span class="title">性能测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/Jmeter/" class="nav-link">
  Jemter
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/document/Nginx/01-安装与配置.html" class="sidebar-link">安装与配置</a></li><li><a href="/document/Nginx/02-基本配置与优化.html" class="active sidebar-link">基本配置与优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#完整配置示例" class="sidebar-link">完整配置示例</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#虚拟主机配置" class="sidebar-link">虚拟主机配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#什么是虚拟主机" class="sidebar-link">什么是虚拟主机</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#配置基于-ip-的虚拟主机" class="sidebar-link">配置基于 IP 的虚拟主机</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#配置基于域名的虚拟主机" class="sidebar-link">配置基于域名的虚拟主机</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#日志文件配置与切割" class="sidebar-link">日志文件配置与切割</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#日志格式" class="sidebar-link">日志格式</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#日志文件存放路径" class="sidebar-link">日志文件存放路径</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#日志文件切割" class="sidebar-link">日志文件切割</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#压缩输出配置" class="sidebar-link">压缩输出配置</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#自动列目录配置" class="sidebar-link">自动列目录配置</a></li><li class="sidebar-sub-header"><a href="/document/Nginx/02-基本配置与优化.html#浏览器本地缓存设置" class="sidebar-link">浏览器本地缓存设置</a></li></ul></li><li><a href="/document/Nginx/高可用实现.html" class="sidebar-link">高可用实现</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="完整配置示例"><a href="#完整配置示例" class="header-anchor">#</a> 完整配置示例</h2> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 使用的用户和组</span>
<span class="token attr-name">user</span> <span class="token attr-value"> nobody;</span>
<span class="token comment"># 指定工作衍生进程数（一般等于CPU的总核数或总核数的两倍，例如两个四核CPU，则总核数为8）</span>
<span class="token attr-name">worker_processes</span> <span class="token attr-value"> 1;</span>

<span class="token comment"># 指定错误日志存放的路径，错误日志记录级别可选项为：[ debug | info | notice | warn | error | crit ]</span>
<span class="token attr-name">error_log</span> <span class="token attr-value"> logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#error_log  logs/error.log  info;</span>

<span class="token comment"># 指定pid存放的路径 </span>
<span class="token attr-name">pid</span> <span class="token attr-value">       logs/nginx.pid;</span>


<span class="token attr-name">events</span> <span class="token attr-value">{</span>
<span class="token comment">		# 使用的网络I/O模型，Linux 系统推荐采用 epoll 模型，FreeBSD 系统推荐采用 kqueue 模型</span>
<span class="token attr-name">		use</span> <span class="token attr-value">epoll;</span>
<span class="token comment">		# 允许的连接数</span>
<span class="token attr-name">    worker_connections</span> <span class="token attr-value"> 1024;</span>
}


<span class="token attr-name">http</span> <span class="token attr-value">{</span>
<span class="token attr-name">    include</span> <span class="token attr-value">      mime.types;</span>
<span class="token attr-name">    default_type</span> <span class="token attr-value"> application/octet-stream;</span>
<span class="token comment">    # 设置使用的字符集，如果一个网站有多个字符集，请不要随便设置，应让程序员在 HTML 代码中通过 Meta 标签设置</span>
    charset			gb2132;
    
<span class="token attr-name">    server_names_hash_bucket_size</span> <span class="token attr-value">128;</span>
<span class="token attr-name">    client_header_buffer_size</span> <span class="token attr-value">32k;</span>
<span class="token attr-name">    large_client_header_buffers</span> <span class="token attr-value">4 32k;</span>
<span class="token attr-name">    log_format</span> <span class="token attr-value"> main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
<span class="token attr-name">                      '$status</span> <span class="token attr-value">$body_bytes_sent &quot;$http_referer&quot; '</span>
<span class="token attr-name">                      '&quot;$http_user_agent&quot;</span> <span class="token attr-value">&quot;$http_x_forwarded_for&quot;';</span>

<span class="token attr-name">    access_log</span> <span class="token attr-value"> logs/access.log  main;</span>

<span class="token attr-name">    sendfile</span> <span class="token attr-value">       on;</span>
<span class="token attr-name">    tcp_nopush</span> <span class="token attr-value">    on;</span>

<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value"> 0;</span>
<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value"> 65;</span>
<span class="token comment">    # 开启gzip压缩</span>
<span class="token attr-name">    gzip</span> <span class="token attr-value"> on;</span>

<span class="token attr-name">    server</span> <span class="token attr-value">{</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">      80;</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value"> localhost;</span>

<span class="token comment">        #charset koi8-r;</span>

<span class="token attr-name">        access_log</span> <span class="token attr-value"> logs/host.access.log  main;</span>

<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">            root</span> <span class="token attr-value">  html;</span>
<span class="token attr-name">            index</span> <span class="token attr-value"> index.html index.htm;</span>
        }

<span class="token attr-name">        error_page</span> <span class="token attr-value"> 404              /404.html;</span>

<span class="token comment">        # redirect server error pages to the static page /50x.html</span>
<span class="token attr-name">        error_page</span> <span class="token attr-value">  500 502 503 504  /50x.html;</span>
<span class="token attr-name">        location</span> <span class="token punctuation">=</span> <span class="token attr-value">/50x.html {</span>
<span class="token attr-name">            root</span> <span class="token attr-value">  html;</span>
        }

<span class="token comment">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<span class="token comment">        #</span>
<span class="token comment">        #location ~ \.php$ {</span>
<span class="token comment">        #    proxy_pass   http://127.0.0.1;</span>
<span class="token comment">        #}</span>

<span class="token comment">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<span class="token comment">        #</span>
<span class="token comment">        #location ~ \.php$ {</span>
<span class="token comment">        #    root           html;</span>
<span class="token comment">        #    fastcgi_pass   127.0.0.1:9000;</span>
<span class="token comment">        #    fastcgi_index  index.php;</span>
<span class="token comment">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
<span class="token comment">        #    include        fastcgi_params;</span>
<span class="token comment">        #}</span>

<span class="token comment">        # deny access to .htaccess files, if Apache's document root</span>
<span class="token comment">        # concurs with nginx's one</span>
<span class="token comment">        #</span>
<span class="token comment">        #location ~ /\.ht {</span>
<span class="token comment">        #    deny  all;</span>
<span class="token comment">        #}</span>
    }


<span class="token comment">    # another virtual host using mix of IP-, name-, and port-based configuration</span>
<span class="token comment">    #</span>
<span class="token comment">    #server {</span>
<span class="token comment">    #    listen       8000;</span>
<span class="token comment">    #    listen       somename:8080;</span>
<span class="token comment">    #    server_name  somename  alias  another.alias;</span>

<span class="token comment">    #    location / {</span>
<span class="token comment">    #        root   html;</span>
<span class="token comment">    #        index  index.html index.htm;</span>
<span class="token comment">    #    }</span>
<span class="token comment">    #}</span>


<span class="token comment">    # HTTPS server</span>
<span class="token comment">    #</span>
<span class="token comment">    #server {</span>
<span class="token comment">    #    listen       443 ssl;</span>
<span class="token comment">    #    server_name  localhost;</span>

<span class="token comment">    #    ssl_certificate      cert.pem;</span>
<span class="token comment">    #    ssl_certificate_key  cert.key;</span>

<span class="token comment">    #    ssl_session_cache    shared:SSL:1m;</span>
<span class="token comment">    #    ssl_session_timeout  5m;</span>

<span class="token comment">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span>
<span class="token comment">    #    ssl_prefer_server_ciphers  on;</span>

<span class="token comment">    #    location / {</span>
<span class="token comment">    #        root   html;</span>
<span class="token comment">    #        index  index.html index.htm;</span>
<span class="token comment">    #    }</span>
<span class="token comment">    #}</span>
}
</code></pre></div><h2 id="虚拟主机配置"><a href="#虚拟主机配置" class="header-anchor">#</a> 虚拟主机配置</h2> <h3 id="什么是虚拟主机"><a href="#什么是虚拟主机" class="header-anchor">#</a> 什么是虚拟主机</h3> <p>虚拟主机使用的是特殊的软硬件技术，它把一台运行在因特网上的服务器主机分成一台台“虚拟”的主机，每台虚拟主机都可以是一个独立的网站，可以有具体的域名，具有完整的 Internet 服务器功能（<code>WWW</code>、<code>FTP</code>、<code>Email</code>等），同一台主机上的虚拟主机之间是完全独立的。从网站访问者来看，每一台虚拟主机和一台独立的主机完全一样。</p> <p>利用虚拟主机，不用为每个要运行的网站提供一台单独的 Nginx 服务器或单独运行一组Nginx进程。虚拟主机提供了在同一台服务器、同一组 <code>Nginx</code> 进程上运行多个网站的功能。</p> <p>在 <code>Nginx</code> 配置文件 <code>nginx.conf</code> 中，一个最简化的虚拟主机配置如下所示：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">http</span> <span class="token attr-value">{</span>
<span class="token attr-name">	server</span> <span class="token attr-value">{</span>
		listen		80 default;
		server_name	 _ *;
		access_log	 logs/default.access.log main;
<span class="token attr-name">		location</span> <span class="token attr-value">/ {</span>
			index	index.html;
			root	/usr/local/server1
		}
	}
}
</code></pre></div><p>跟 <code>Apache</code> 一样，<code>Nginx</code> 也可以配置多种类型的虚拟主机：一是基于 <code>IP</code> 的虚拟主机，二是基于域名的虚拟主机。三是基于端口的虚拟主机。</p> <h3 id="配置基于-ip-的虚拟主机"><a href="#配置基于-ip-的虚拟主机" class="header-anchor">#</a> 配置基于 IP 的虚拟主机</h3> <p><code>Linux</code>、<code>FreeBSD</code> 操作系统都允许添加 IP 别名。IP别名背后的概念很简单：在一块物理网卡上绑定多个 IP 地址。这样就能够在使用单一网卡的同一个服务器上运行多个基于 IP 的虚拟主机。设置 IP 别名也非常容易，只需配置系统上的网络接口，让它监听额外的 IP 地址。在 <code>Linux</code> 系统上，可以使用标准的网络配置工具（比如 <code>ifconfig</code> 和 <code>route</code> 命令）添加IP 别名。</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">eth0</span><span class="token punctuation">:</span> <span class="token attr-value">flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="token attr-name">        inet</span> <span class="token attr-value">172.29.147.144  netmask 255.255.240.0  broadcast 172.29.159.255</span>
<span class="token attr-name">        inet6</span> <span class="token attr-value">fe80::216:3eff:fe19:865d  prefixlen 64  scopeid 0x20&lt;link&gt;</span>
<span class="token attr-name">        ether</span> <span class="token attr-value">00:16:3e:19:86:5d  txqueuelen 1000  (Ethernet)</span>
<span class="token attr-name">        RX</span> <span class="token attr-value">packets 6125152  bytes 1576085539 (1.4 GiB)</span>
<span class="token attr-name">        RX</span> <span class="token attr-value">errors 0  dropped 0  overruns 0  frame 0</span>
<span class="token attr-name">        TX</span> <span class="token attr-value">packets 4414005  bytes 2425194768 (2.2 GiB)</span>
<span class="token attr-name">        TX</span> <span class="token attr-value">errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span>

<span class="token attr-name">lo</span><span class="token punctuation">:</span> <span class="token attr-value">flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span>
<span class="token attr-name">        inet</span> <span class="token attr-value">127.0.0.1  netmask 255.0.0.0</span>
<span class="token attr-name">        inet6</span> <span class="token punctuation">:</span><span class="token attr-value">:1  prefixlen 128  scopeid 0x10&lt;host&gt;</span>
<span class="token attr-name">        loop</span> <span class="token attr-value"> txqueuelen 1000  (Local Loopback)</span>
<span class="token attr-name">        RX</span> <span class="token attr-value">packets 48  bytes 4470 (4.3 KiB)</span>
<span class="token attr-name">        RX</span> <span class="token attr-value">errors 0  dropped 0  overruns 0  frame 0</span>
<span class="token attr-name">        TX</span> <span class="token attr-value">packets 48  bytes 4470 (4.3 KiB)</span>
<span class="token attr-name">        TX</span> <span class="token attr-value">errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span>
</code></pre></div><p>如上所示，这台服务器有一块物理网卡设备 <code>eth0</code> ，和本地回环设备 <code>lo</code>, <code>eth0</code> 的 <code>IP</code> 地址为 <code>172.29.147.144</code>，本地回环 <code>lo</code> 的 IP 地址为 <code>127.0.0.1</code>；</p> <p>本地回环代表设备的本地虚拟接口，所以默认被看做是永远不会宕机的接口。它的主要作用有两个：一是测试本机的网络配置，能 <code>ping</code> 通 <code>127.0.0.1</code> 说明本机的网卡和 IP协议安装都没有问题；另一个作用是某些 <code>server/client</code> 的应用程序在运行时需调用服务器上的资源，一般要指定 <code>server</code> 的 IP 地址，但当该程序要在同一台服务器上运行且没有别的 <code>server</code> 时，就可以把 <code>server</code> 的资源装在本机上，<code>server</code> 的 IP 地址设为 <code>127.0.0.1</code> 也同样可以运行。</p> <p>如果要在 <code>eth0</code> 网卡设备上添加一个 <code>IP</code> 别名 <code>172.29.147.145</code> ,可以通过一下命令来进行：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ifconfig</span> eth0:1 <span class="token number">172.29</span>.147.145 broadcast <span class="token number">172.29</span>.159.255 netmask <span class="token number">255.255</span>.240.0 up
</code></pre></div><p>但是，通过 <code>ifconfig</code>  和 <code>route</code> 配置的 <code>IP</code> 别名在服务器重启后会消失，不过可以将这两条 <code>ifconfig</code>  和 <code>route</code> 命令添加到 <code>/etc/rc.local</code> 文件中，让系统开机时自动运行，以下是相关命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/rc.local
</code></pre></div><p>在文件末尾增加以下内容，然后保存即可：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ifconfig</span> eth0:1 <span class="token number">172.29</span>.147.145 broadcast <span class="token number">172.29</span>.159.255 netmask <span class="token number">255.255</span>.240.0 up
</code></pre></div><p>下面开始配置基于 <code>IP</code> 的虚拟主机。无论是通过 <code>IP</code> 别名在一台服务器上配置多个 <code>IP</code> 地址，还是通过多块网卡在服务器上配置多个 <code>IP</code> 地址，在 <code>Nginx</code> 中都能将其配置成为基于 <code>IP</code> 的虚拟主机。</p> <p>在 <code>Nginx</code> 配置文件 （<code>nginx.conf</code>）中，分别对 <code>172.29.147.144</code> 、<code>172.29.147.145</code> 配置两个纯静态 <code>HTML</code> 支持的虚拟主机，具体配置如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">server</span> <span class="token attr-value">{</span>
<span class="token attr-name">	listen</span> <span class="token attr-value">      80;</span>
<span class="token attr-name">    server_name</span> <span class="token attr-value">172.29.147.144;</span>
<span class="token attr-name">    location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">    	root</span> <span class="token attr-value"> /usr/local/server1;</span>
<span class="token attr-name">        index</span> <span class="token attr-value"> index.html index.htm;</span>
    }
}
<span class="token attr-name">server</span> <span class="token attr-value">{</span>
<span class="token attr-name">	listen</span> <span class="token attr-value">      80;</span>
<span class="token attr-name">  	server_name</span> <span class="token attr-value">172.29.147.145;</span>
<span class="token attr-name">  	location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">		root</span> <span class="token attr-value"> /usr/local/server2;</span>
<span class="token attr-name">  		index</span> <span class="token attr-value"> index.html index.htm;</span>
 	}
}
</code></pre></div><p>从上面的配置文件可以看出，一段 <code>server{.......}</code> 就是一个虚拟主机，如果要配置多个虚拟主机，建立多段 <code>server{}</code> 配置即可。监听的 <code>IP</code> 和端口可以不写 <code>IP</code> 地址，只写端口号，不写端口号即表示监听该服务器上所有 <code>IP</code> 的该端口号，可通过 <code>server_name</code> 区分不同的虚拟主机。</p> <h3 id="配置基于域名的虚拟主机"><a href="#配置基于域名的虚拟主机" class="header-anchor">#</a> 配置基于域名的虚拟主机</h3> <p>基于域名的虚拟主机是<strong>最常见</strong>的一种虚拟主机。只需配置你的 <code>DNS</code> 服务器，将每个主机名映射到正确的 IP 地址，然后配置 <code>Nginx</code> 服务器，令其识别不同的主机名就可以了。这种虚拟主机技术，使很多虚拟主机可以共享同一个 <code>IP</code> 地址，有效解决了 <code>IP</code> 地址不足的问题。<strong>所以，如果没有特殊要求使你必须用一个基于 <code>IP</code> 的虚拟主机，最好还是使用基于域名的虚拟主机。</strong></p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">http</span> <span class="token attr-value">{</span>
<span class="token attr-name">	server</span> <span class="token attr-value">{</span>
<span class="token comment">        # 监听的端口</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">     80;</span>
<span class="token comment">        # 主机名称</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value">aaa.domain.com;</span>
<span class="token comment">        # 访问日志文件存放路径</span>
        access_log	logs/aaa.domain.com.access.log main;
<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token comment">			# 默认首页文件，顺序从左到右，如果找不到 index.html 文件，则查找 index.htm 文件作为首页文件</span>
<span class="token attr-name">			index</span> <span class="token attr-value"> index.html index.htm;</span>
<span class="token comment">			# HTML 网页文件存放的目录</span>
<span class="token attr-name">			root</span> <span class="token attr-value"> /usr/local/aaa;</span>
        }
	}
<span class="token attr-name">    server</span> <span class="token attr-value">{</span>
<span class="token comment">        # 监听的端口</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">     80;</span>
<span class="token comment">        # 主机名称</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value">bbb.otherdomain.com;</span>
<span class="token comment">        # 访问日志文件存放路径</span>
        access_log	logs/bbb.otherdomain.com.access.log main;
<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token comment">			# 默认首页文件，顺序从左到右，如果找不到 index.html 文件，则查找 index.htm 文件作为首页文件</span>
<span class="token attr-name">			index</span> <span class="token attr-value"> index.html index.htm;</span>
<span class="token comment">			# HTML 网页文件存放的目录</span>
<span class="token attr-name">			root</span> <span class="token attr-value"> /usr/local/bbb;</span>
        }
	}
<span class="token attr-name">	server</span> <span class="token attr-value">{</span>
<span class="token comment">        # 监听的端口</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">     80;</span>
<span class="token comment">        # 主机名称</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value">www.domain.com domain.com *.domain.com;</span>
<span class="token comment">        # 访问日志文件存放路径</span>
        access_log	logs/ccc.domain.com.access.log main;
<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token comment">			# 默认首页文件，顺序从左到右，如果找不到 index.html 文件，则查找 index.htm 文件作为首页文件</span>
<span class="token attr-name">			index</span> <span class="token attr-value"> index.html index.htm;</span>
<span class="token comment">			# HTML 网页文件存放的目录</span>
<span class="token attr-name">			root</span> <span class="token attr-value"> /usr/local/ccc;</span>
        }
	}
}
</code></pre></div><p>在上述示例中，配置了三个虚拟主机，第一个虚拟主机表示所有对域名 <code>aaa.domain.com</code> 的访问都由它来处理，第二个虚拟主机表示所有对域名 <code>bbb.otherdomain.com</code> 的访问都由它来处理，第三个虚拟主机表示对域名 <code>www.domain.com</code> 、<code>domain.com</code> ，以及除了 <code>aaa.domain.com</code>  之外的所有 <code>*.domain.com</code> 二级域名的访问都由它来处理。每个虚拟主机的网页文件分别存放在了不同的目录中，每个虚拟主机使用了不同的日志文件来记录访问日志。</p> <h2 id="日志文件配置与切割"><a href="#日志文件配置与切割" class="header-anchor">#</a> 日志文件配置与切割</h2> <h3 id="日志格式"><a href="#日志格式" class="header-anchor">#</a> 日志格式</h3> <p><code>Nginx</code> 使用 <code>log_format</code> 指令来设置日志的记录格式，它的语法如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">log_format</span> <span class="token attr-value">name format [format ...]</span>
</code></pre></div><p>各参数解释如下：</p> <table><thead><tr><th style="text-align:center;">参数</th> <th style="text-align:center;">含义</th></tr></thead> <tbody><tr><td style="text-align:center;">name</td> <td style="text-align:center;">定义的格式名称</td></tr> <tr><td style="text-align:center;">format</td> <td style="text-align:center;">定义的格式样式</td></tr></tbody></table> <p><code>log_format</code> 有一个默认的、无需设置的 <code>main</code> 日志格式设置，相当于 <code>Apache</code> 的 <code>combined</code> 日志格式，其具体参数如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">log_format</span> <span class="token attr-value"> main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
<span class="token attr-name">                  '$status</span> <span class="token attr-value">$body_bytes_sent &quot;$http_referer&quot; '</span>
<span class="token attr-name">                  '&quot;$http_user_agent&quot;</span> <span class="token attr-value">&quot;$http_x_forwarded_for&quot;';</span>
</code></pre></div><p>各参数解释如下：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">remote_addr</td> <td style="text-align:left;">反向代理服务器的IP地址</td></tr> <tr><td style="text-align:left;">remote_user</td> <td style="text-align:left;">远程客户端用户名称</td></tr> <tr><td style="text-align:left;">time_local</td> <td style="text-align:left;">访问时间与时区</td></tr> <tr><td style="text-align:left;">request</td> <td style="text-align:left;">请求URL与 HTTP 协议</td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">请求状态</td></tr> <tr><td style="text-align:left;">body_bytes_sent</td> <td style="text-align:left;">发送给客户端的文件主体内容大小</td></tr> <tr><td style="text-align:left;">http_referer</td> <td style="text-align:left;">记录从哪个页面访问过来的</td></tr> <tr><td style="text-align:left;">http_user_agent</td> <td style="text-align:left;">记录客户端浏览器的相关信息</td></tr> <tr><td style="text-align:left;">http_x_forwarded_for</td> <td style="text-align:left;">客户真实IP地址</td></tr></tbody></table> <p>也可以自定义一份日志的记录格式，不过要注意，<code>log_format</code> 指令设置的 <code>name</code> 名称在 <code>Nginx</code> 配置文件中是不能重复的。</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">172.29.147.144</span> <span class="token attr-value">- - [27/Aug/2021:17:15:19 +0800] &quot;GET / HTTP/1.1&quot; 200 163 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;-&quot;</span>
<span class="token attr-name">172.29.147.144</span> <span class="token attr-value">- - [27/Aug/2021:17:15:22 +0800] &quot;GET / HTTP/1.1&quot; 200 163 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;-&quot;</span>
<span class="token attr-name">172.29.147.144</span> <span class="token attr-value">- - [27/Aug/2021:17:15:23 +0800] &quot;GET / HTTP/1.1&quot; 200 163 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;-&quot;</span>
</code></pre></div><h3 id="日志文件存放路径"><a href="#日志文件存放路径" class="header-anchor">#</a> 日志文件存放路径</h3> <p><code>Nginx</code> 使用 <code>access_log</code> 指令来指定日志文件存放路径。该指令语法如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code>access_log	path	[format	[buffer<span class="token punctuation">=</span>size | off]]
</code></pre></div><p>其中 <code>path</code> 表示日志文件的存放路径，<code>format</code> 表示使用 <code>log_format</code> 指令设置的日志格式的名称，<code>buffer=size</code>  表示设置内存缓冲区的大小，例如可以设置 <code>buffer=32k</code>。</p> <h5 id="不记录日志"><a href="#不记录日志" class="header-anchor">#</a> 不记录日志</h5> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># off 表示关闭日志记录</span>
access_log	off;
</code></pre></div><h5 id="使用默认的-main-格式记录日志"><a href="#使用默认的-main-格式记录日志" class="header-anchor">#</a> 使用默认的 <code>main</code> 格式记录日志</h5> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># main 可不写</span>
<span class="token attr-name">access_log</span> <span class="token attr-value">/logs/access.log main;</span>
</code></pre></div><h5 id="使用自定义格式的日志记录"><a href="#使用自定义格式的日志记录" class="header-anchor">#</a> 使用自定义格式的日志记录</h5> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">log_format</span> <span class="token attr-value"> main1  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
<span class="token attr-name">                  '$status</span> <span class="token attr-value">$body_bytes_sent &quot;$http_referer&quot; '</span>
<span class="token attr-name">                  '&quot;$http_user_agent&quot;</span> <span class="token attr-value">&quot;$http_x_forwarded_for&quot;';</span>
<span class="token attr-name"> access_log</span> <span class="token attr-value">/logs/access.log main1 buffer=32k;</span>
</code></pre></div><h5 id="nginx-0-7-4-之后的版本中-access-log-指令中的日志文件路径可以包含变量"><a href="#nginx-0-7-4-之后的版本中-access-log-指令中的日志文件路径可以包含变量" class="header-anchor">#</a> <code>Nginx 0.7.4</code> 之后的版本中，<code>access_log</code> 指令中的日志文件路径可以包含变量</h5> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># server_name 为变量名</span>
<span class="token attr-name">access_log</span> <span class="token attr-value">/logs/$server_name.log main;</span>
</code></pre></div><p>如果日志文件路径中含有变量，将存在一下一些限制：</p> <ul><li>Nginx 进程设置的用户和组必须有对该路径创建文件的权限。</li></ul> <p>假设 <code>Nginx</code> 的 <code>user</code> 指令设置的用户名和用户组都是 <code>www</code>，而 <code>/data/logs/</code> 目录的用户名和用户组为 <code>root</code>，日志文件将无法被 <code>Nginx</code> 创建。</p> <ul><li>缓冲区将不会被使用</li> <li>对于每一条日志记录，日志文件都将先打开文件，再写入日志记录，然后马上关闭。</li></ul> <p>为了提高包含变量的日志文件存放路径的性能，需要使用 <code>open_log_file_cache</code> 指令设置经常被使用的日志文件描述符缓存。它的语法如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">open_log_file_cache</span> <span class="token attr-value">max=N [inactive=time] [min_uses=N] [valid=time] | off</span>
</code></pre></div><p>该指令默认是禁止的，等同于：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">open_log_file_cache</span> <span class="token attr-value">off;</span>
</code></pre></div><p><code>open_log_file_cache</code> 指令的各项参数说明如下：</p> <p><code>max</code> ：设置缓存中的最大文件描述符数量。如果超过设置的最大文件描述符数量，则采用 LRU（Least Recently Used）算法清除 “较布行使用的文件描述符” 。 LRU（Least Recently Used）算法的基本概念是：当内存缓冲区剩余的可用空间不足时，缓冲区尽可能先保留使用者最常使用的数据，将最近未使用的数据移出内存，腾出空间来加载另外的数据。</p> <p><code>inactive</code> ：设置一个时间，如果在设置的时间内没有使用此文件描述符，则自动删除此描述符。此参数为可选参数，默认时间为 10 秒钟。</p> <p><code>min_uses</code> ：在参数 inactive 指定的时间范围内，如果日志文件超过被使用的次数，则将该日志文件的描述符记入缓存。默认次数为1。</p> <p><code>valid</code> ：设置多长时间检查一次，看一看变量指定的日志文件路径与文件名是否仍然存在。默认时间为 60 秒。</p> <p><code>off</code> ：禁止使用缓存。</p> <p><code>open_log_file_cache</code> 指令的设置示例如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">open_log_file_cache</span> <span class="token attr-value">max=1000 inactive=20s min_uses=2 valid=1m;</span>
</code></pre></div><h2 id="日志文件切割"><a href="#日志文件切割" class="header-anchor">#</a> 日志文件切割</h2> <p>生产环境中的服务器，由于访问日志文件增长速度非常快，日志太大会严重影响服务器效率。同时，为了方便对日志进行分析计算，需要对日志文件进行定时切割。定时切割的方式有按月切割、按天切割、按小时切割等。最常用的是按天切割。</p> <p>Nginx可以采用一下方式来实现日志切割：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mv</span> /data1/logs/access.log /data1/logs/20210101.log
<span class="token function">kill</span> -usr1 Nginx主进程号
或者
<span class="token function">kill</span> -usr1 <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /usr/local/nginx/logs/nginx.pid<span class="token variable">`</span></span>
</code></pre></div><p>首先通过 mv 命令将日志文件重命名为 <code>/data1/logs/20210101.log</code> ，然后发送 kill -usr1 信号给 Nginx的主进程号，让 Nginx 重新生成一个新的日志文件 <code>/data1/logs/access.log</code> 。</p> <ul><li>每天定时切割日志</li></ul> <p>如果想每天定时切割日志，还需要借助 crontab。我们可以写一个按天切割的日志，按年、月份目录存放日志的 shell 脚本：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /usr/local/nginx/cut_nginx_log.sh
</code></pre></div><p>shell 脚本内容如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment">#!/bin/bash</span>
<span class="token comment"># 这个脚本需在每天的 00:00 运行</span>

<span class="token comment"># Nginx 日志文件的存放路径</span>
<span class="token attr-name">logs_path</span><span class="token punctuation">=</span><span class="token attr-value">'/data1/logs'</span>

<span class="token attr-name">mkdir</span> <span class="token attr-value">-p ${logs_path}${date -d 'yesterday' +'%Y'}/${date -d 'yesterday' +'%m'} /</span>
<span class="token attr-name">mv</span> <span class="token attr-value">${logs_path}access.log ${logs_path}${date -d 'yesterday' +'%Y'}/${date -d 'yesterday' +'%m'}/access_${date -d 'yesterday' + '%Y%m%d'}.log</span>
<span class="token attr-name">kill</span> <span class="token attr-value">-usr1 `cat /usr/local/nginx/logs/nginx.pid`</span>
</code></pre></div><p>配置 crontab 每天凌晨 00:00 定时执行这个脚本：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">crontab</span> -e
</code></pre></div><p>输入一下内容并保存：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">00</span> <span class="token attr-value">00 * * * /bin/bash /usr/local/nginx/cut_nginx_log.sh</span>
</code></pre></div><p>这个 shell 脚本和 crontab 配置主要实现的功能为：假设今天的日期为 2009 年 5 月 19 日，Nginx当前的日志文件为  <code>/data1/logs/access.log</code> ，2009 年 5 月 20 日 00：00 会执行 <code>cur_nginx_log.sh</code> 脚本，<code>cur_nginx_log.sh</code> 脚本首先创建一个目录为 <code>/data1/logs/2009/05/</code>，然后将 <code>/data1/logs/access.log</code> 文件移动并重命名为 <code>/data1/logs/2009/05/access_20090519.log</code>，再发送 kill -usr1 信号给 Nginx 主进程，告诉 Nginx 重新生成一个 <code>/data1/logs/access.log</code> 文件，2009 年 5 月 20 日的日志记录在这个新生成的日志文件中。而  <code>/data1/logs/2009/05/access_20090519.log</code> 文件，就是  2009 年 5 月 19 日的日志文件。</p> <h2 id="压缩输出配置"><a href="#压缩输出配置" class="header-anchor">#</a> 压缩输出配置</h2> <p>gzip（GNU-ZIP）是一种压缩技术。经过 gzip 压缩后页面大小可以变为原来的 30% 甚至更小。这样，用户在浏览页面的时候速度会快很多。gzip的压缩页面需要浏览器和服务器双方都支持，实际上就是服务端压缩，传到浏览器后浏览器解压并解析。浏览器哪里不需要我们担心，因为 IE、Firefox、Opera、谷歌Chrome等绝大多数浏览器都支持解析 gzip 过的页面。</p> <p>Nginx 的压缩输出由一组 gzip 压缩指令来实现。gzip 压缩输出的相关指令位于 <code>http{......}</code> 两个大括号之间：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">gzip</span> <span class="token attr-value">on;</span>
gzip_min_length	1k;
<span class="token attr-name">gzip_buffers</span> <span class="token attr-value">		4 16k;</span>
gzip_http_version	1.1;
gzip_comp_level	2;
gzip_types	text/plain	application/x-javascript	text/css	application/xml;
gzip_vary	on;
</code></pre></div><h2 id="自动列目录配置"><a href="#自动列目录配置" class="header-anchor">#</a> 自动列目录配置</h2> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">location</span> <span class="token attr-value">/ {</span>
	autoindex	on;
}
</code></pre></div><p>相关命令：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 设定索引时文件大小的单位（B、KB、MB 或 GB）</span>
autoindex_exact_size	[ on | off ]
<span class="token comment"># 开启以本地时间来显示文件时间的功能。默认为关（GMT时间）</span>
autoindex_location	[ on | off ]
</code></pre></div><h2 id="浏览器本地缓存设置"><a href="#浏览器本地缓存设置" class="header-anchor">#</a> 浏览器本地缓存设置</h2> <p>浏览器缓存是为了加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器旧可以从本地磁盘显示文档，这样就可以加速页面的浏览。缓存的方式节约了网络的资源，提高了网络的效率。</p> <p>浏览器缓存可以通过 expires 指令输出 Header 头来实现，指令语法如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code>expires	[time | epoch | max | off]
</code></pre></div><p>本指令默认值为 <code>expires off</code>，作用域为 <code>http</code>、<code>server</code>、<code>location</code>。使用本指令可以控制 HTTP 应答中的 Expires  和 Cache-Control 的 Header 头信息（起到控制页面缓存的作用）。各参数含义如下：</p> <ul><li>time</li></ul> <p>可以使用正数或负数。Expires 头标的值将通过当前系统时间加上设定的 time 值来获得。</p> <ul><li>epoch</li></ul> <p>指定 Expires 的值为 1 January,1970,00:00:01 GMT。</p> <ul><li>max</li></ul> <p>指定 Expires 的值为 31 December 2037 23:59:59 GMT，Cache-Control 的值为 10 年。-1 指定 Expires 的值为服务器当前时间 -1s，即永不过期。</p> <p>Cache-Control 头标的值由指定的时间来决定。</p> <p>负数：<code>Cache-Control：no-chche</code>。</p> <p>正数或零：<code>Cache-Control：max-age=#,#</code> 为指定时间的秒数。</p> <ul><li>off</li></ul> <p>不修改 Expires 和 Cache-Control 的值。</p> <p>例：对常见格式的图片、Flash文件在浏览器本地缓存 30 天，对 js 、css 文件在浏览器本地缓存 1 小时，代码如下所示：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">location</span> <span class="token attr-value">~ .*\.(gif|jpg|jpeg|png|bmp|swf){</span>
<span class="token attr-name">	expires</span> <span class="token attr-value">30d;</span>
}
<span class="token attr-name">location</span> <span class="token attr-value">~ .*\.(js|css){</span>
	expires	1h;
}
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">2021-09-01 21:46:57</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/document/Nginx/01-安装与配置.html" class="prev">
        安装与配置
      </a></span> <span class="next"><a href="/document/Nginx/高可用实现.html">
        高可用实现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/document/assets/js/app.3d477e64.js" defer></script><script src="/document/assets/js/2.3edc90c1.js" defer></script><script src="/document/assets/js/59.b3a0d72b.js" defer></script>
  </body>
</html>
